<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
</head>

<body>
    <h1>회원가입</h1>

    <form id="signup-form">
        <label for="phoneNumber">전화번호:</label>
        <input type="text" id="phoneNumber" name="phoneNumber" required>
        <button type="button" id="send-otp">인증</button><br><br>

        <!-- OTP 입력 필드 -->
        <div id="otp-section" style="display:none;">
            <label for="otp">OTP 입력:</label>
            <input type="text" id="otp" name="otp" required>
            <button type="button" id="verify-otp">OTP 인증</button><br><br>
        </div>

        <label for="nickname">닉네임:</label>
        <input type="text" id="nickname" name="nickname" required><br><br>

        <label for="password">비밀번호:</label>
        <input type="password" id="password" name="password" required><br><br>

        <label for="language">언어 선택:</label>
        <select id="language" name="language">
            <option value="ko">한국어</option>
            <option value="en">영어</option>
        </select><br><br>

        <label for="country">나라 선택:</label>
        <input list="countries" id="country" name="country">
        <datalist id="countries">
            <option value="Afghanistan">
            <option value="Albania">
            <option value="Algeria">
            <option value="Andorra">
            <option value="Angola">
            <option value="Antigua and Barbuda">
            <option value="Argentina">
            <option value="Armenia">
            <option value="Australia">
            <option value="Austria">
            <option value="Azerbaijan">
            <option value="Bahamas">
            <option value="Bahrain">
            <option value="Bangladesh">
            <option value="Barbados">
            <option value="Belarus">
            <option value="Belgium">
            <option value="Belize">
            <option value="Benin">
            <option value="Bhutan">
            <option value="Bolivia">
            <option value="Bosnia and Herzegovina">
            <option value="Botswana">
            <option value="Brazil">
            <option value="Brunei">
            <option value="Bulgaria">
            <option value="Burkina Faso">
            <option value="Burundi">
            <option value="Cabo Verde">
            <option value="Cambodia">
            <option value="Cameroon">
            <option value="Canada">
            <option value="Central African Republic">
            <option value="Chad">
            <option value="Chile">
            <option value="China">
            <option value="Colombia">
            <option value="Comoros">
            <option value="Congo (Congo-Brazzaville)">
            <option value="Costa Rica">
            <option value="Croatia">
            <option value="Cuba">
            <option value="Cyprus">
            <option value="Czechia (Czech Republic)">
            <option value="Democratic Republic of the Congo">
            <option value="Denmark">
            <option value="Djibouti">
            <option value="Dominica">
            <option value="Dominican Republic">
            <option value="Ecuador">
            <option value="Egypt">
            <option value="El Salvador">
            <option value="Equatorial Guinea">
            <option value="Eritrea">
            <option value="Estonia">
            <option value="Eswatini (fmr. 'Swaziland')">
            <option value="Ethiopia">
            <option value="Fiji">
            <option value="Finland">
            <option value="France">
            <option value="Gabon">
            <option value="Gambia">
            <option value="Georgia">
            <option value="Germany">
            <option value="Ghana">
            <option value="Greece">
            <option value="Grenada">
            <option value="Guatemala">
            <option value="Guinea">
            <option value="Guinea-Bissau">
            <option value="Guyana">
            <option value="Haiti">
            <option value="Honduras">
            <option value="Hungary">
            <option value="Iceland">
            <option value="India">
            <option value="Indonesia">
            <option value="Iran">
            <option value="Iraq">
            <option value="Ireland">
            <option value="Israel">
            <option value="Italy">
            <option value="Jamaica">
            <option value="Japan">
            <option value="Jordan">
            <option value="Kazakhstan">
            <option value="Kenya">
            <option value="Kiribati">
            <option value="Kuwait">
            <option value="Kyrgyzstan">
            <option value="Laos">
            <option value="Latvia">
            <option value="Lebanon">
            <option value="Lesotho">
            <option value="Liberia">
            <option value="Libya">
            <option value="Liechtenstein">
            <option value="Lithuania">
            <option value="Luxembourg">
            <option value="Madagascar">
            <option value="Malawi">
            <option value="Malaysia">
            <option value="Maldives">
            <option value="Mali">
            <option value="Malta">
            <option value="Marshall Islands">
            <option value="Mauritania">
            <option value="Mauritius">
            <option value="Mexico">
            <option value="Micronesia">
            <option value="Moldova">
            <option value="Monaco">
            <option value="Mongolia">
            <option value="Montenegro">
            <option value="Morocco">
            <option value="Mozambique">
            <option value="Myanmar (formerly Burma)">
            <option value="Namibia">
            <option value="Nauru">
            <option value="Nepal">
            <option value="Netherlands">
            <option value="New Zealand">
            <option value="Nicaragua">
            <option value="Niger">
            <option value="Nigeria">
            <option value="North Korea">
            <option value="North Macedonia">
            <option value="Norway">
            <option value="Oman">
            <option value="Pakistan">
            <option value="Palau">
            <option value="Panama">
            <option value="Papua New Guinea">
            <option value="Paraguay">
            <option value="Peru">
            <option value="Philippines">
            <option value="Poland">
            <option value="Portugal">
            <option value="Qatar">
            <option value="Romania">
            <option value="Russia">
            <option value="Rwanda">
            <option value="Saint Kitts and Nevis">
            <option value="Saint Lucia">
            <option value="Saint Vincent and the Grenadines">
            <option value="Samoa">
            <option value="San Marino">
            <option value="Sao Tome and Principe">
            <option value="Saudi Arabia">
            <option value="Senegal">
            <option value="Serbia">
            <option value="Seychelles">
            <option value="Sierra Leone">
            <option value="Singapore">
            <option value="Slovakia">
            <option value="Slovenia">
            <option value="Solomon Islands">
            <option value="Somalia">
            <option value="South Africa">
            <option value="South Korea">
            <option value="South Sudan">
            <option value="Spain">
            <option value="Sri Lanka">
            <option value="Sudan">
            <option value="Suriname">
            <option value="Sweden">
            <option value="Switzerland">
            <option value="Syria">
            <option value="Tajikistan">
            <option value="Tanzania">
            <option value="Thailand">
            <option value="Timor-Leste">
            <option value="Togo">
            <option value="Tonga">
            <option value="Trinidad and Tobago">
            <option value="Tunisia">
            <option value="Turkey">
            <option value="Turkmenistan">
            <option value="Tuvalu">
            <option value="Uganda">
            <option value="Ukraine">
            <option value="United Arab Emirates">
            <option value="United Kingdom">
            <option value="United States">
            <option value="Uruguay">
            <option value="Uzbekistan">
            <option value="Vanuatu">
            <option value="Vatican City">
            <option value="Venezuela">
            <option value="Vietnam">
            <option value="Yemen">
            <option value="Zambia">
            <option value="Zimbabwe">
        </datalist><br><br>

        <label for="region">지역 선택(광역시):</label>
        <select id="region" name="region">
            <option value="서울특별시">서울특별시</option>
            <option value="부산광역시">부산광역시</option>
            <option value="대구광역시">대구광역시</option>
            <option value="인천광역시">인천광역시</option>
            <option value="광주광역시">광주광역시</option>
            <option value="대전광역시">대전광역시</option>
            <option value="울산광역시">울산광역시</option>
            <option value="세종특별자치시">세종특별자치시</option>
        </select><br><br>

        <label for="tags">관심사 선택(복수 선택 가능):</label><br>
        <input type="checkbox" name="tags" value="유학"> 유학<br>
        <input type="checkbox" name="tags" value="음악"> 음악<br>
        <input type="checkbox" name="tags" value="운동"> 운동<br>
        <input type="checkbox" name="tags" value="미술"> 미술<br><br>

        <label for="receiveNotifications">알림 수신 동의:</label>
        <input type="checkbox" id="receiveNotifications" name="receiveNotifications"><br><br>

        <button type="submit" id="signup-button" disabled>회원가입</button>
    </form>

    <script>
        let otpVerified = false;

        // OTP 발송
        document.getElementById('send-otp').addEventListener('click', async function () {
            const phoneNumber = document.getElementById('phoneNumber').value;

            if (phoneNumber === '') {
                alert('전화번호를 입력하세요.');
                return;
            }

            if (!phoneNumber.match(/^01[0-9]{8,9}$/)) {
                alert('올바른 전화번호 형식을 입력해주세요.');
                return;
            }

            try {
				// 전화번호 중복 체크 및 OTP 발송 요청
				const response = await fetch('http://localhost:3000/api/sms/auth/otp', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ phoneNumber }),
				});

				if (!response.ok) {
					throw new Error(`서버 오류: ${response.status}`);
				}

				const data = await response.json();

				if (data.isDuplicate) {
					alert('중복된 전화번호입니다.');
				} else if (data.otpSent) {
					alert('OTP가 발송되었습니다.');
					document.getElementById('otp-section').style.display = 'block';  // OTP 입력란 보이기
				} else {
					alert('OTP 발송에 실패했습니다.');
				}
			} catch (error) {
				console.error('OTP 발송 오류:', error);
				alert('서버 오류로 인해 OTP 발송에 실패했습니다.');
			}
        });

        // OTP 인증
        document.getElementById('verify-otp').addEventListener('click', async function () {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const otp = document.getElementById('otp').value;

            const response = await fetch('http://localhost:3000/api/sms/auth/otp/validation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ phoneNumber, code: otp })
            });

            const data = await response.json();

            if (data.verified) {
                alert('OTP 인증이 완료되었습니다.');
                otpVerified = true;  // 인증 성공 시 flag 설정
                document.getElementById('signup-button').disabled = false;  // 회원가입 버튼 활성화

                // 휴대폰 번호 입력, OTP 버튼, OTP 입력 및 인증 버튼 비활성화
                document.getElementById('phoneNumber').disabled = true;
                document.getElementById('send-otp').disabled = true;
                document.getElementById('otp').disabled = true;
                document.getElementById('verify-otp').disabled = true;
            } else {
                alert('OTP 인증에 실패했습니다.');
            }
        });

        // 회원가입 처리
        document.getElementById('signup-form').addEventListener('submit', async function (event) {
            event.preventDefault();

            if (!otpVerified) {
                alert('OTP 인증을 완료해주세요.');
                return;
            }

            const formData = {
                phoneNumber: document.getElementById('phoneNumber').value,
                nickname: document.getElementById('nickname').value,
                password: document.getElementById('password').value,
                language: document.getElementById('language').value,
                country: document.getElementById('country').value,
                region: document.getElementById('region').value,
                tags: Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(checkbox => checkbox.value),
                receiveNotifications: document.getElementById('receiveNotifications').checked
            };

            const response = await fetch('http://localhost:3000/api/signUp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                alert('회원가입이 완료되었습니다!');
                window.location.href = 'login.html';  // 회원가입 후 로그인 페이지로 리디렉션
            } else {
                alert('회원가입에 실패하였습니다.');
            }
        });
    </script>
</body>

</html>
